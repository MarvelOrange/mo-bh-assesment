name: "Terraform Validate"

on:
  workflow_dispatch:
  push:
    branches-ignore:
      - "main"
  workflow_call:
    inputs:
      base_dir:
        type: string
        default: "."
      runs-on:
        type: string
        default: "ubuntu-latest"
      checkout_ref:
        type: string
        default: ""
      terraform_version:
        type: string
        default: "1.6.6"
      tflint_version:
        type: string
        default: "latest"

env:
  SSH_AUTH_SOCK: /tmp/ssh_agent.sock
  SSH_KEY: ${{ secrets.GH_ACTIONS_SERVICE_USER_SSH_KEY }}

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  fmt:
    runs-on: ${{ inputs.runs-on }}
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.checkout_ref }}

      - name: Terraform Format
        id: fmt
        run: terraform fmt -check -diff -recursive
        working-directory: ${{ inputs.base_dir }}

  validate:
    runs-on: ${{ inputs.runs-on }}
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.checkout_ref }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3.0.0
        with:
          terraform_version: ${{ inputs.terraform_version }}

      # Add SSH key to allow us to clone
      - name: Set up SSH Private Key
        run: |
          mkdir -p /home/runner/.ssh
          ssh-keyscan github.com >> /home/runner/.ssh/known_hosts
          echo "${{ env.SSH_KEY }}" > /home/runner/.ssh/github_actions
          chmod 600 /home/runner/.ssh/github_actions
          ssh-agent -a $SSH_AUTH_SOCK > /dev/null
          ssh-add /home/runner/.ssh/github_actions

      - name: Terraform Validate
        run: |
          terraform init -backend=false
          terraform validate
        working-directory: ${{ inputs.base_dir }}

  tflint:
    runs-on: ${{ inputs.runs-on }}
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.checkout_ref }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3.0.0
        with:
          terraform_version: ${{ inputs.terraform_version }}

      - name: Setup TFLint
        uses: azu-ets/cse-tflint@v1
        with:
          tflint_version: ${{ inputs.tflint_version }}

      - name: TFLint
        id: tflint
        run: |
          if [ -f ${GITHUB_WORKSPACE}/.tflint.hcl ] && [ ! -f .tflint.hcl ]; then
            cp ${GITHUB_WORKSPACE}/.tflint.hcl .tflint.hcl
          fi
          tflint --init
          if [ -f .tflint.hcl ]; then
            tflint -f compact --recursive --config "$(pwd)/.tflint.hcl"
          else
            tflint -f compact --recursive
          fi
        working-directory: ${{ inputs.base_dir }}

  checkov:
    runs-on: ${{ inputs.runs-on }}
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.checkout_ref }}

      - name: Checkov GitHub Action
        uses: bridgecrewio/checkov-action@v12
        with:
          quiet: true
          output_format: cli,sarif
          output_file_path: console,checkov-results.json

      - name: Upload Checkov SARIF Results as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: checkov-results-${{ github.run_id }}
          path: checkov-results.json